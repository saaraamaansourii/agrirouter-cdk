openapi: 3.0.3
info:
  title: Account Service API
  version: 1.0.0
  description: The API to manage accounts and users on agrirouter.
servers:
  - url: http://account.localhost:{port}
    variables:
      port:
        default: "8000"
  - url: http://localhost:{port}
    description: Localhost Server
    variables:
      port:
        default: "8080"
  - url: https://account-service.dev.agrirouter.farm
    description: Development Server
  - url: https://account-service.qa.agrirouter.farm
    description: QA Server
  - url: https://account-service.prod.agrirouter.farm
    description: Production Server

security:
  - openIdLocalhost:
      - "farmer"
  - openIdLocalK3d:
      - "farmer"
  - openIdDev:
      - "farmer"
  - openIdQa:
      - "farmer"

paths:
  /tenant:
    post:
      summary: Create a new tenant
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/tenantCreateRequest"
      responses:
        "201":
          description: Successfully created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/tenant"
          headers:
            x-request-id:
              description: "Unique ID to identify the request."
              schema:
                type: string
        "400":
          $ref: ../common/responses/bad_request.yaml
        "500":
          $ref: ../common/responses/internal_server_error.yaml
  /tenant/{id}:
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: string
          format: uuid
    get:
      summary: Return a tenant
      responses:
        "200":
          description: Successfully returned the information
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/tenant"
          headers:
            x-request-id:
              description: "Unique ID to identify the request."
              schema:
                type: string
        "404":
          $ref: ../common/responses/not_found.yaml
        "500":
          $ref: ../common/responses/internal_server_error.yaml
    put:
      summary: Update an tenant
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/tenantUpdateRequest"
      responses:
        "200":
          description: Successfully updated
          headers:
            x-request-id:
              description: "Unique ID to identify the request."
              schema:
                type: string
        "400":
          $ref: ../common/responses/bad_request.yaml
        "500":
          $ref: ../common/responses/internal_server_error.yaml
  /tenants:
    get:
      summary: Return all tenants in the admin's realm
      responses:
        "200":
          description: Successfully returned a list of all tenants
          content:
            application/json:
              schema:
                type: object
                properties:
                  tenantList:
                    type: array
                    items:
                      $ref: "#/components/schemas/tenant"
          headers:
            x-request-id:
              description: "Unique ID to identify the request."
              schema:
                type: string
        "400":
          $ref: ../common/responses/bad_request.yaml
        "500":
          $ref: ../common/responses/internal_server_error.yaml
      security:
        - openIdLocalhost:
            - "administrator"
        - openIdDev:
            - "administrator"
        - openIdQa:
            - "administrator"
        - openIdLocalK3d:
            - "administrator"
  /account:
    get:
      summary: Return an account and the user information
      responses:
        "200":
          description: Successfully returned the information
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/accountResponse"
          headers:
            x-request-id:
              description: "Unique ID to identify the request."
              schema:
                type: string
        "400":
          $ref: ../common/responses/bad_request.yaml
        "500":
          $ref: ../common/responses/internal_server_error.yaml

    put:
      summary: Update and add to account information
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/accountRequest"
      responses:
        "200":
          description: Successfully updated the account
          headers:
            x-request-id:
              description: "Unique ID to identify the request."
              schema:
                type: string
        "400":
          $ref: ../common/responses/bad_request.yaml
        "500":
          $ref: ../common/responses/internal_server_error.yaml

    delete:
      summary: Delete an account
      responses:
        "204":
          $ref: ../common/responses/no_content.yaml
        "400":
          $ref: ../common/responses/bad_request.yaml
        "500":
          $ref: ../common/responses/internal_server_error.yaml
  /account/email:
    put:
      summary: Update Email
      requestBody:
        description: Update email address
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                email:
                  type: string
                  example: "hallo@example.com"
      responses:
        "200":
          description: Successfully changed the email address
          headers:
            x-request-id:
              description: "Unique ID to identify the request."
              schema:
                type: string
        "400":
          $ref: ../common/responses/bad_request.yaml
        "409":
          description: Duplication error, email already exists
          headers:
            x-request-id:
              description: "Unique ID to identify the request."
              schema:
                type: string
        "500":
          $ref: ../common/responses/internal_server_error.yaml
  /user/{id}/developer-status:
    put:
      summary: Update Developer Status
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        description: Update developer status
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                developerStatus:
                  type: string
                  enum: ["accepted", "rejected"]
      security:
        - openIdLocalhost:
            - "administrator"
        - openIdDev:
            - "administrator"
      responses:
        "200":
          description: Successfully changed the developer status or roles of a farmer
          headers:
            x-request-id:
              description: "Unique ID to identify the request."
              schema:
                type: string
        "400":
          $ref: ../common/responses/bad_request.yaml
        "500":
          $ref: ../common/responses/internal_server_error.yaml
  /current-user/developer-status:
    put:
      summary: Update Developer Status
      requestBody:
        description: Update developer status
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                developerStatus:
                  type: string
                  enum: ["pending"]
      responses:
        "200":
          description: Successfully changed the developer status or roles of a farmer
          headers:
            x-request-id:
              description: "Unique ID to identify the request."
              schema:
                type: string
        "400":
          $ref: ../common/responses/bad_request.yaml
        "500":
          $ref: ../common/responses/internal_server_error.yaml
    get:
      summary: Return the developer status of requesting user
      responses:
        "200":
          description: Successfully returned the developer status
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/developerStatus"
          headers:
            x-request-id:
              description: "Unique ID to identify the request."
              schema:
                type: string
        "404":
          $ref: ../common/responses/not_found.yaml
        "500":
          $ref: ../common/responses/internal_server_error.yaml
  /admin:
    post:
      summary: Create a new admin
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/adminEntity"
      responses:
        "201":
          description: Successfully created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/adminEntity"
          headers:
            x-request-id:
              description: "Unique ID to identify the request."
              schema:
                type: string
        "400":
          $ref: ../common/responses/bad_request.yaml
        "500":
          $ref: ../common/responses/internal_server_error.yaml
      security:
        - openIdLocalhost:
            - "administrator"
        - openIdDev:
            - "administrator"
        - openIdQa:
            - "administrator"
        - openIdLocalK3d:
            - "administrator"
  /admin/{id}:
    delete:
      summary: Delete an admin
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "204":
          description: Successfully removed
          headers:
            x-request-id:
              description: "Unique ID to identify the request."
              schema:
                type: string
        "400":
          $ref: ../common/responses/bad_request.yaml
        "500":
          $ref: ../common/responses/internal_server_error.yaml
      security:
        - openIdLocalhost:
            - "administrator"
        - openIdDev:
            - "administrator"
        - openIdQa:
            - "administrator"
        - openIdLocalK3d:
            - "administrator"
  /accounts:
    get:
      summary: Return all accounts in the admin's realm
      parameters:
        - name: role
          in: query
          required: false
          schema:
            type: array
            items:
              type: string
              enum: ["farmer", "developer", "administrator"]
          style: form
          explode: false
          examples:
            all-roles:
              value: []
            multiple-roles:
              value: ["farmer", "developer"]
              description: "Returns all accounts with the roles farmer and developer"

      responses:
        "200":
          description: Successfully returned a list of all accounts
          content:
            application/json:
              schema:
                type: object
                properties:
                  accountList:
                    type: array
                    items:
                      $ref: "#/components/schemas/accountResponse"
          headers:
            x-request-id:
              description: "Unique ID to identify the request."
              schema:
                type: string
        "400":
          $ref: ../common/responses/bad_request.yaml
        "500":
          $ref: ../common/responses/internal_server_error.yaml
      security:
        - openIdLocalhost:
            - "administrator"
        - openIdDev:
            - "administrator"
        - openIdQa:
            - "administrator"
        - openIdLocalK3d:
            - "administrator"
  /accounts/pending-as-dev:
    get:
      summary: Return all farmer accounts that have the state pending for role of developer
      responses:
        "200":
          description: Successfully returned a list of all accounts
          content:
            application/json:
              schema:
                type: object
                properties:
                  accountList:
                    type: array
                    items:
                      $ref: "#/components/schemas/accountResponse"
          headers:
            x-request-id:
              description: "Unique ID to identify the request."
              schema:
                type: string
        "400":
          $ref: ../common/responses/bad_request.yaml
        "500":
          $ref: ../common/responses/internal_server_error.yaml
      security:
        - openIdLocalhost:
            - "administrator"
        - openIdDev:
            - "administrator"
        - openIdQa:
            - "administrator"
        - openIdLocalK3d:
            - "administrator"
  /preference:
    put:
      summary: Store and update the machine hall and application preferences
      requestBody:
        description: Machine hall preferences
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/preference"
      responses:
        "200":
          description: Successfully stored the preference
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/preference"

          headers:
            x-request-id:
              description: "Unique ID to identify the request."
              schema:
                type: string
        "400":
          $ref: ../common/responses/bad_request.yaml
        "500":
          $ref: ../common/responses/internal_server_error.yaml

    get:
      summary: Return the stored machine hall and application preferences
      responses:
        "200":
          description: Successfully returned a list of all accounts
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/preference"
          headers:
            x-request-id:
              description: "Unique ID to identify the request."
              schema:
                type: string
        "400":
          $ref: ../common/responses/bad_request.yaml
        "404":
          $ref: ../common/responses/not_found.yaml
        "500":
          $ref: ../common/responses/internal_server_error.yaml

  # Tester resources
  /testers/invitations:
    post:
      operationId: createTesterInvitation
      summary: Invite a new tester to test the tenant application version set as approved for testing
      parameters:
        - in: header # remove the header for endpoints that are not scoped to a specific Tenant
          name: x-tenant-id
          schema:
            type: string
          required: true
          description: "Tenant id to scope the request to"
      requestBody:
        description: Email of new potential tester to be invited
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email
              properties:
                email:
                  type: string
                  example: "wannabetester@example.com"
      responses:
        "201":
          description: Successfully sent invite to potential new tester
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/tester"
          headers:
            x-request-id:
              $ref: ../common/headers.yaml#/x-request-id
        "400":
          description: Bad Request - Failed to invite tenant as tester
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/invite_tester_400"
          headers:
            x-request-id:
              $ref: ../common/headers.yaml#/x-request-id
        "500":
          $ref: ../common/responses/internal_server_error.yaml
      security:
        - openIdLocalhost:
            - "developer"
        - openIdDev:
            - "developer"
        - openIdQa:
            - "developer"
        - openIdLocalK3d:
            - "developer"
    get:
      summary: Return all pending and accepted tester invitations in the tenant
      operationId: getTesterInvitations
      parameters:
        - in: header
          name: x-tenant-id
          schema:
            type: string
          required: true
          description: "Tenant Id to scope the request to"
      responses:
        "200":
          description: Successfully returned a list of all tester invitations (pending and accepted)
          content:
            application/json:
              schema:
                type: object
                properties:
                  testerInvitations:
                    type: array
                    items:
                      $ref: "#/components/schemas/tester"
          headers:
            x-request-id:
              description: "Unique ID to identify the request."
              schema:
                type: string
        "500":
          $ref: ../common/responses/internal_server_error.yaml
      security:
        - openIdLocalhost:
            - "developer"
        - openIdDev:
            - "developer"
        - openIdQa:
            - "developer"
        - openIdLocalK3d:
            - "developer"
  /testers/invitations/{tenantId}:
    parameters:
      - name: tenantId
        in: path
        required: true
        schema:
          type: string
          format: uuid
      - in: header
        name: x-tenant-id
        schema:
          type: string
        required: true
        description: "Tenant Id to scope the request to"
    delete:
      summary: Developer will delete a tester invitation
      operationId: deleteTesterInvitation
      responses:
        "204":
          description: Successfully removed the tester. This does not guarantee that an email to the discontinued tester has been sent.
          headers:
            x-request-id:
              description: "Unique ID to identify the request."
              schema:
                type: string
        "400":
          $ref: ../common/responses/bad_request.yaml
        "500":
          $ref: ../common/responses/internal_server_error.yaml
      security:
        - openIdLocalhost:
            - "developer"
        - openIdDev:
            - "developer"
        - openIdQa:
            - "developer"
        - openIdLocalK3d:
            - "developer"
  /testers/invitations/{tenantId}/accept:
    parameters:
      - name: tenantId
        in: path
        required: true
        schema:
          type: string
          format: uuid
    put:
      summary: User will accept the tester invitation and set their tenant as Tester
      operationId: acceptTesterInvitation
      parameters:
        - in: header
          name: x-tenant-id
          schema:
            type: string
          required: true
          description: "Tenant Id to scope the request to"
      responses:
        "200":
          description: Successfully accepted the invitation
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/tenant"

          headers:
            x-request-id:
              description: "Unique ID to identify the request."
              schema:
                type: string
        "400":
          $ref: ../common/responses/bad_request.yaml
        "404":
          $ref: ../common/responses/not_found.yaml
        "500":
          $ref: ../common/responses/internal_server_error.yaml
  /tester/tenants:
    get:
      summary: Tenant list the user's tenant is testing for or has been invited by
      operationId: getTesterTenants
      parameters:
        - in: header
          name: x-tenant-id
          schema:
            type: string
          required: true
          description: "Tenant Id to scope the request to"
      responses:
        "200":
          description: Successfully returned a list of all accepted tenants the farmer is testing for or has been invited by
          content:
            application/json:
              schema:
                type: object
                properties:
                  testerInvitations:
                    type: array
                    items:
                      $ref: "#/components/schemas/testerTenant"
          headers:
            x-request-id:
              description: "Unique ID to identify the request."
              schema:
                type: string
        "500":
          $ref: ../common/responses/internal_server_error.yaml
  /tester/tenants/{tenantId}:
    parameters:
      - name: tenantId
        in: path
        required: true
        schema:
          type: string
          format: uuid
      - in: header
        name: x-tenant-id
        schema:
          type: string
        required: true
        description: "Tenant Id to scope the request to"
    delete:
      summary: The user's tenant will stop testing for this tenant
      description: Delete existing tenant by tenant_id
      operationId: stopTestingForTenant
      responses:
        "204":
          description: Tenant deleted successfully
          headers:
            x-request-id:
              description: "Unique ID to identify the request."
              schema:
                type: string
        "400":
          $ref: ../common/responses/bad_request.yaml
        "500":
          $ref: ../common/responses/internal_server_error.yaml
  /location/country:
    get:
      summary: Return the counry of the requesting client's IP in the requested language
      operationId: getClientCountry
      responses:
        "200":
          description: Successfully returned the country ISO Code matching the client's IP address in the requested language
          content:
            application/json:
              schema:
                type: object
                required:
                  - clientCountryISOCode
                properties:
                  clientCountryISOCode:
                    type: string
          headers:
            x-request-id:
              description: "Unique ID to identify the request."
              schema:
                type: string
        "404":
          description: ClientIP of the request was not transmitted.
          headers:
            x-request-id:
              $ref: ../common/headers.yaml#/x-request-id
        "500":
          $ref: ../common/responses/internal_server_error.yaml

components:
  securitySchemes:
    openIdLocalhost:
      $ref: ../common/security/openid_local.yaml
    openIdDev:
      $ref: ../common/security/openid_dev.yaml
    openIdQa:
      $ref: ../common/security/openid_qa.yaml

  schemas:
    tenant:
      type: object
      required:
        - company_name
        - tenant_id
      properties:
        company_name:
          type: string
          example: "CompanyX"
        company_description:
          type: string
          example: "Agriculture Supplier"
        manufacturer_code:
          type: string
          example: "Ox123AB"
        tenant_id:
          type: string
          format: uuid
        country_iso_code:
          type: string
          example : "UAE"
    testerTenant:
      allOf:
        - $ref: "#/components/schemas/tenant"
        - type: object
          required:
            - status
          properties:
            status:
              type: string
              enum: ["pending", "accepted"]
    tenantCreateRequest:
      type: object
      required:
        - company_name
      properties:
        company_name:
          type: string
          example: "CompanyX"
        company_description:
          type: string
          example: "Agriculture Supplier"
        country_iso_code:
          type: string
          example : "UAE"
    tenantUpdateRequest:
      type: object
      properties:
        company_name:
          type: string
          example: "CompanyX"
        company_description:
          type: string
          example: "Agriculture Supplier"
        country_iso_code:
          type: string
          example : "UAE"

    adminEntity:
      type: object
      required:
        - first_name
        - last_name
        - email
      properties:
        first_name:
          type: string
          example: "Arnold"
        last_name:
          type: string
          example: "Admin"
        email:
          type: string
          example: "arnold.admin@gmail.com"

    locale:
      type: string
      enum: [de, en, nl, fr, it, pl, pt-BR, ru, es]
      example: "en"

    accountRequest:
      type: object
      properties:
        first_name:
          type: string
          example: "Max"
        last_name:
          type: string
          example: "Mustermann"
        address:
          type: string
          example: "Musterstreet 3"
        postal_code:
          type: string
          example: "12345"
        city:
          type: string
          example: "Munich"
        country:
          type: string
          example: "Germany"
        locale:
          $ref: '#/components/schemas/locale'
        phone_number:
          type: string
          example: "00491234"

    accountResponse:
      type: object
      required:
        - id
        - first_name
        - last_name
        - email
        - tenant
        - tenant_company_name
      properties:
        id:
          type: string
          format: uuid
        first_name:
          type: string
          example: "Max"
        last_name:
          type: string
          example: "Mustermann"
        email:
          type: string
          example: "max.m@gmail.com"
        tenant:
          type: string
          example: "tenant1"
        tenant_company_name:
          type: string
          example: "Reply"
        tenant_company_description:
          type: string
          example: "Agriculture Supplier"
        tenant_manufacturer_code:
          type: string
          example: "1234x0"
        address:
          type: string
          example: "Musterstreet 3"
        postal_code:
          type: string
          example: "12345"
        city:
          type: string
          example: "Munich"
        country:
          type: string
          example: "Germany"
        locale:
          $ref: '#/components/schemas/locale'
        phone_number:
          type: string
          example: "00491234"

    preference:
      type: object
      required:
        - applications
        - manufacturers
      properties:
        applications:
          type: array
          items:
            type: object
            required:
              - id
            properties:
              id:
                type: string
                format: uuid
        manufacturers:
          type: array
          items:
            type: object
            required:
              - name
              - endpoints
            properties:
              name:
                type: string
              endpoints:
                type: array
                items:
                  type: string
                  format: uuid

    developerStatus:
      type: object
      properties:
        developerStatus:
          type: string
          enum: ["", "pending", "accepted", "rejected"]

    tester:
      allOf:
        - $ref: "#/components/schemas/testerTenant"
        - type: object
          required:
            - emails
          properties:
            emails:
              type: array
              items:
                type: string
                format: email
    invite_tester_400:
      type: object
      required:
          - error_code
      properties:
        error_code:
          type: string
          description: Textual error code message explaining why tenant could not be invited as tester
          enum: ["user_not_found", "own_tenant_id", "user_tenant_not_set", "tenant_not_stored", "tenant_already_invited"]
